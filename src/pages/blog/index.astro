---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Link from '../../components/Link.astro';

type Post = CollectionEntry<'blog'>;

const posts: Post[] = (await getCollection('blog'))
  .filter((post: Post) => !post.data.draft)
  .sort(
    (a: Post, b: Post) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
  );

const years: number[] = [
  ...new Set(posts.map((post) => post.data.pubDate.getUTCFullYear())),
];

const metadata = {
  title: 'Blog',
  useTitleTemplate: true,
};
---

<Layout metadata={metadata}>
  {
    years.map((year) => (
      <section>
        <h2 class='mt-0'>{year}</h2>
        <ul class='list-none'>
          {posts
            .filter((post) => post.data.pubDate.getUTCFullYear() === year)
            .map((post) => {
              const formattedDate = new Intl.DateTimeFormat('en-US', {
                month: 'short',
                day: 'numeric',
                timeZone: 'UTC',
              }).format(post.data.pubDate);

              return (
                <li class='-ml-4'>
                  <span class='mr-1 text-gray-500'>{formattedDate}</span>
                  <Link url={`/blog/${post.id}/`} self={true}>
                    {post.data.title}
                  </Link>
                </li>
              );
            })}
        </ul>
      </section>
    ))
  }
</Layout>
